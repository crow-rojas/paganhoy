<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>¬øPagan Hoy?</title>
    <link rel="icon" type="image/png" href="logo.png" />
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  </head>
  <body>
    <div class="container">
      <h1>¬øPagan Hoy? ü§ë</h1>
      <p id="answer"></p>
    </div>

    <script>
      let confettiInterval; // Variable global para el intervalo del confeti

      async function checkPayments() {
        try {
          const response = await fetch("payment-dates.json");
          const data = await response.json();
          const { paymentDates } = data;

          const countries_where_will_pay = [];
          const countries_where_not_pay = [];
          const today = new Date();
          const year = today.getFullYear();
          const month = today.getMonth() + 1;
          const day = today.getDate();

          for (let countryCode in paymentDates) {
            const country = paymentDates[countryCode];
            if (country.dates[year]?.[month]?.includes(day)) {
              countries_where_will_pay.push({ code: countryCode, ...country });
            } else if (country.dates[year]) {
              countries_where_not_pay.push({ code: countryCode, ...country });
            }
          }

          let message = "";
          let sadMessage = "";

          if (countries_where_will_pay.length === 0) {
            message = "No, hoy no pagan en ning√∫n pa√≠s. üòû";
            const sadImg = document.createElement("img");
            sadImg.id = "payImg";
            sadImg.src = "cuando_fokin_pagan.jpeg";
            sadImg.alt = "Payment Status Image";
            document.querySelector("div").appendChild(sadImg);
          } else {
            const payingCountries = countries_where_will_pay
              .map((c) => `${c.name} ${c.emoji}`)
              .join(", ");

            message = `¬°S√≠! Hoy pagan en ${payingCountries}. üéâ`;

            // Crear contenedor para las im√°genes y m√∫sica
            const celebrationContainer = document.createElement("div");
            celebrationContainer.className = "celebration-container";

            // Crear la imagen principal primero
            const mainImg = document.createElement("img");
            mainImg.id = "payImg";
            mainImg.src = "fokin_pagaron.jpeg";
            mainImg.alt = "Payment Status Image";

            // Agregar bot√≥n de m√∫sica
            const musicButton = document.createElement("button");
            musicButton.id = "musicButton";
            musicButton.className = "music-button";
            musicButton.innerHTML = `
              <span class="music-icon">‚ñ∂Ô∏è</span>
              <span class="music-label">¬°Presi√≥name para celebrar!</span>
            `;

            // Agregar gatos
            const leftCat = document.createElement("img");
            leftCat.id = "leftCat";
            leftCat.src = "gato.png";
            leftCat.className = "celebration-cat";

            const rightCat = document.createElement("img");
            rightCat.id = "rightCat";
            rightCat.src = "gato.png";
            rightCat.className = "celebration-cat";

            // Agregar audio
            const audio = document.createElement("audio");
            audio.id = "celebrationAudio";
            audio.src = "gato_ql_loco.mp3";

            // Agregar elementos al contenedor en el orden correcto
            celebrationContainer.appendChild(leftCat);
            celebrationContainer.appendChild(mainImg);
            celebrationContainer.appendChild(rightCat);

            // Agregar elementos al DOM
            const container = document.querySelector("div");
            container.appendChild(musicButton);
            container.appendChild(celebrationContainer);
            container.appendChild(audio);

            // Configurar el bot√≥n de m√∫sica
            let isPlaying = false;
            musicButton.addEventListener("click", () => {
              const audio = document.getElementById("celebrationAudio");
              const leftCat = document.getElementById("leftCat");
              const rightCat = document.getElementById("rightCat");

              if (isPlaying) {
                audio.pause();
                musicButton.innerHTML = `
                  <span class="music-icon">‚ñ∂Ô∏è</span>
                  <span class="music-label">¬°Presi√≥name para celebrar!</span>
                `;
                leftCat.src = "gato.png";
                rightCat.src = "gato.png";
                // Detener el confeti
                if (confettiInterval) {
                  clearInterval(confettiInterval);
                  confettiInterval = null;
                }
              } else {
                audio.play();
                musicButton.innerHTML = `
                  <span class="music-icon">‚è∏Ô∏è</span>
                  <span class="music-label">Pausar celebraci√≥n</span>
                `;
                leftCat.src = "oiia-oiiaoiia.gif";
                rightCat.src = "oiia-oiiaoiia.gif";
                // Iniciar confeti continuo
                confettiInterval = setInterval(throwConfetti, 50);
              }
              isPlaying = !isPlaying;
            });

            document
              .getElementById("answer")
              .classList.add("payment-celebration");

            // Celebraci√≥n con confeti
            celebratePayment();

            if (countries_where_not_pay.length > 0) {
              const notPayingCountries = countries_where_not_pay
                .map((c) => `${c.name} ${c.emoji}`)
                .join(", ");
              sadMessage = `Pero no pagan en ${notPayingCountries} üò¢`;
            }
          }

          document.getElementById("answer").innerHTML = message;

          // Crear o actualizar el elemento para el mensaje triste
          let sadMessageElement = document.getElementById("sadAnswer");
          if (!sadMessageElement) {
            sadMessageElement = document.createElement("p");
            sadMessageElement.id = "sadAnswer";
            document.querySelector("div").appendChild(sadMessageElement);
          }

          if (sadMessage) {
            sadMessageElement.innerHTML = sadMessage;
            // Agregar imagen peque√±a de cuando_fokin_pagan
            let sadImg = document.getElementById("sadImg");
            if (!sadImg) {
              sadImg = document.createElement("img");
              sadImg.id = "sadImg";
              sadImg.src = "cuando_fokin_pagan.jpeg";
              sadImg.alt = "Sad Payment Status";
              sadImg.className = "small-img";
              document.querySelector("div").appendChild(sadImg);
            }
          }
        } catch (error) {
          console.error("Error cargando las fechas de pago:", error);
          document.getElementById("answer").innerHTML =
            "Error cargando las fechas de pago üò±";
        }
      }

      // Ejecutar la verificaci√≥n cuando carga la p√°gina
      checkPayments();

      function findNextPaymentForAllCountries(paymentDates) {
        const today = new Date();
        const nextPayments = [];

        for (let countryCode in paymentDates) {
          const country = paymentDates[countryCode];
          let nextDate = null;

          for (let year in country.dates) {
            for (let month in country.dates[year]) {
              for (let day of country.dates[year][month]) {
                const paymentDate = new Date(year, month - 1, day);
                if (
                  paymentDate > today &&
                  (!nextDate || paymentDate < nextDate)
                ) {
                  nextDate = paymentDate;
                }
              }
            }
          }

          if (nextDate) {
            const daysLeft = Math.ceil(
              (nextDate - today) / (1000 * 60 * 60 * 24)
            );
            nextPayments.push({
              country,
              date: nextDate,
              daysLeft,
            });
          }
        }

        return nextPayments;
      }

      function getRandomBrokePhrase(days) {
        const phrases = [
          "Mi billetera est√° m√°s vac√≠a que nevera de estudiante üò≠",
          "Comiendo arroz con imaginaci√≥n hasta entonces üçö",
          "Modo supervivencia activado ü¶ñ",
          "Mi cuenta bancaria est√° en modo zen: vac√≠a y en paz üßò‚Äç‚ôÇÔ∏è",
          "Buscando monedas en el sof√° como deporte extremo üèÉ‚Äç‚ôÇÔ∏è",
          days < 3
            ? "¬°Ya casi! Aguanta mi rey/reina üëë"
            : "Toca comer aire gourmet üçΩÔ∏è",
          days < 5
            ? "La luz al final del t√∫nel se acerca üî¶"
            : "Modo ram√©n instant√°neo: ON üçú",
          "Mi billetera tiene telara√±as üï∏Ô∏è",
          "Hasta las tarjetas de cr√©dito tienen miedo üí≥",
          "Mi cuenta est√° en n√∫meros m√°s rojos que un tomate üçÖ",
        ];
        return phrases[Math.floor(Math.random() * phrases.length)];
      }

      // Agregar funci√≥n de celebraci√≥n
      function celebratePayment() {
        // Explosi√≥n inicial de confeti
        confetti({
          particleCount: 150,
          spread: 100,
          origin: { y: 0.6 },
          colors: ["#ff0000", "#00ff00", "#0000ff", "#ffff00", "#ff00ff"],
        });

        // Intervalo inicial de 3 segundos
        const animationDuration = 3000;
        const animationEnd = Date.now() + animationDuration;

        const interval = setInterval(function () {
          if (Date.now() > animationEnd) {
            return clearInterval(interval);
          }

          throwConfetti();
        }, 50);
      }

      // Funci√≥n para lanzar confeti
      function throwConfetti() {
        confetti({
          particleCount: 3,
          angle: 60,
          spread: 55,
          origin: { x: 0 },
          colors: ["#ff0000", "#00ff00", "#0000ff", "#ffff00", "#ff00ff"],
        });
        confetti({
          particleCount: 3,
          angle: 120,
          spread: 55,
          origin: { x: 1 },
          colors: ["#ff0000", "#00ff00", "#0000ff", "#ffff00", "#ff00ff"],
        });
      }
    </script>

    <div class="container">
      <a
        href="https://github.com/crow-rojas/paganhoy"
        target="_blank"
        class="github-icon"
      >
        <img
          src="github-mark.png"
          alt="Github Repo"
          style="width: 48px; height: 48px"
        />
      </a>
    </div>
  </body>
</html>
